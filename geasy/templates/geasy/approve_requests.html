{% extends 'geasy/navbar.html' %}
{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approve Pending Users</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='geasy/css/styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-container">

        <div class="search-bar">
            <div class="filters-row">
                <select id="statusFilter" class="form-control">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="viewed" {% if filter_status == 'viewed' %}selected{% endif %}>Viewed</option>
                    <option value="on hold" {% if filter_status == 'on hold' %}selected{% endif %}>On Hold</option>
                    <option value="rejected" {% if filter_status == 'rejected' %}selected{% endif %}>Rejected</option>
                </select>
                <input type="text" id="searchInput" value="{{ search }}" placeholder="Search by name, email or login ID" class="form-control">
                <button class="btn btn-primary">Filters</button>
            </div>
        </div>

        <div class="section-title">
            Pending User Requests
            <span class="record-count">{{ users|length }} users</span>
        </div>

        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Mobile 2</th>
                        <th>Machine ID</th>
                        <th>Email</th>
                        <th>State</th>
                        <th>City</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                        <th>Update</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    {% for u in users %}
                        <tr data-name="{{ u.name|lower }}" data-email="{{ u.email|lower }}" data-login-id="{{ u.login_id|lower }}" data-status="{{ u.status|lower }}">
                            <td>{{ u.login_id }}</td>
                            <td>{{ u.name }}</td>
                            <td>{{ u.mobile }}</td>
                            <td>{{ u.mobile2 or '-' }}</td>
                            <td>{{ u.machine_id }}</td>
                            <td>{{ u.email }}</td>
                            <td>{{ u.state }}</td>
                            <td>{{ u.city }}</td>
                            <td>{{ u.date }}</td>
                            <td><span class="status-badge status-{{ u.status.replace(' ', '-') }}">{{ u.status.title() }}</span></td>
                            <td>
                                <button class="btn-sm btn-success approve-btn"
                                        data-user-id="{{ u.id }}"
                                        data-login-id="{{ u.login_id }}"
                                        data-name="{{ u.name }}"
                                        data-mobile="{{ u.mobile }}"
                                        data-city="{{ u.city }}"
                                        data-state="{{ u.state }}"
                                        data-status="{{ u.status }}">
                                    Approve
                                </button>
                            </td>
                            <td>
                                <button class="btn-sm btn-warning update-status-btn"
                                        data-user-id="{{ u.id }}"
                                        data-name="{{ u.name }}"
                                        data-mobile="{{ u.mobile }}"
                                        data-mobile2="{{ u.mobile2 }}"
                                        data-address="{{ u.city }}, {{ u.state }}"
                                        data-current-status="{{ u.status }}">
                                    Status
                                </button>
                            </td>
                            <td>
                                {% if u.location %}
                                    <button class="btn-sm btn-primary view-location-btn" data-user-id="{{ u.id }}">
                                        Location
                                    </button>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr id="noResultsRow">
                            <td colspan="13" class="no-results">No pending requests found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modals remain the same but with updated styling -->
    <div class="modal" id="approveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Approve User</h5>
                <span class="close" onclick="closeModal('approveModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="approveForm">
                    <input type="hidden" id="pending_id" name="pending_id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Login ID *</label>
                            <input type="text" class="form-control" id="approve_login_id" name="login_id" required>
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" class="form-control" id="modal_name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="text" class="form-control" id="modal_mobile" readonly>
                        </div>
                        <div class="form-group">
                            <label>City/State</label>
                            <input type="text" class="form-control" id="modal_location" readonly>
                        </div>
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label>Role *</label>
                            <select class="form-control" id="role" name="role" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select class="form-control" id="status" name="status" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                </form>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmApprove">Approve User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other modals with similar compact styling... -->
    <div class="modal" id="updateStatusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Update User Status</h5>
                <span class="close" onclick="closeModal('updateStatusModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="status_user_id" name="user_id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" class="form-control" id="status_modal_name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" class="form-control" id="status_modal_address" readonly>
                        </div>
                        <div class="form-group">
                            <label>Mobile 1</label>
                            <input type="text" class="form-control" id="status_modal_mobile1" readonly>
                        </div>
                        <div class="form-group">
                            <label>Mobile 2</label>
                            <input type="text" class="form-control" id="status_modal_mobile2" readonly>
                        </div>
                        <div class="form-group">
                            <label>Update Status *</label>
                            <select class="form-control" id="new_status" name="new_status" required>
                                <option value="">Select Status</option>
                                <option value="viewed">Viewed</option>
                                <option value="on hold">On Hold</option>
                                <option value="pending">Pending</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                </form>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('updateStatusModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmStatusUpdate">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="locationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>User Location</h5>
                <span class="close" onclick="closeModal('locationModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="mapContainer" class="map-container">
                    <p>Loading location...</p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn bt-primary" onclick="closeModal('locationModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Success</h5>
                <span class="close" onclick="closeModal('successModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="success-content">
                    <i class="bi bi-check-circle-fill success-icon"></i>
                    <h4 id="successMessage">Operation completed successfully!</h4>
                    <p id="successDetails"></p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn bt-primary" onclick="closeModal('successModal')">Continue</button>
            </div>
        </div>
    </div>

    <script>
        // Same JavaScript functionality as before, just with updated selectors
        let searchTimeout;

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            const modals = ['approveModal', 'updateStatusModal', 'locationModal', 'successModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase().trim();
            const tbody = document.getElementById('usersTableBody');
            const rows = tbody.querySelectorAll('tr:not(#noResultsRow)');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const email = row.getAttribute('data-email') || '';
                const loginId = row.getAttribute('data-login-id') || '';
                const status = row.getAttribute('data-status') || '';

                const searchMatch = !searchTerm || name.includes(searchTerm) || email.includes(searchTerm) || loginId.includes(searchTerm);
                const statusMatch = !statusFilter || status === statusFilter;

                if (searchMatch && statusMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            let noResultsRow = document.getElementById('noResultsRow');
            if (visibleCount === 0 && rows.length > 0) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'noResultsRow';
                    noResultsRow.innerHTML = '<td colspan="13" class="no-results">No matching records found.</td>';
                    tbody.appendChild(noResultsRow);
                }
                noResultsRow.style.display = '';
            } else if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
        }

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('input', debouncedSearch);
            document.getElementById('statusFilter').addEventListener('change', performSearch);

            // Event handlers for buttons (same logic as before)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.approve-btn')) {
                    const btn = e.target.closest('.approve-btn');
                    const userId = btn.getAttribute('data-user-id');
                    const loginId = btn.getAttribute('data-login-id');
                    const name = btn.getAttribute('data-name');
                    const mobile = btn.getAttribute('data-mobile');
                    const city = btn.getAttribute('data-city');
                    const state = btn.getAttribute('data-state');
                    const status = btn.getAttribute('data-status');

                    document.getElementById('pending_id').value = userId;
                    document.getElementById('approve_login_id').value = loginId;
                    document.getElementById('modal_name').value = name;
                    document.getElementById('modal_mobile').value = mobile;
                    document.getElementById('modal_location').value = `${city}, ${state}`;
                    document.getElementById('status').value = status.toLowerCase();
                    openModal('approveModal');
                }
            });

            // Similar event handlers for other buttons...
            document.addEventListener('click', function(e) {
                if (e.target.closest('.update-status-btn')) {
                    const btn = e.target.closest('.update-status-btn');
                    const userId = btn.getAttribute('data-user-id');
                    const name = btn.getAttribute('data-name');
                    const mobile1 = btn.getAttribute('data-mobile');
                    const mobile2 = btn.getAttribute('data-mobile2') || '';
                    const address = btn.getAttribute('data-address');
                    const currentStatus = btn.getAttribute('data-current-status');

                    document.getElementById('status_user_id').value = userId;
                    document.getElementById('status_modal_name').value = name;
                    document.getElementById('status_modal_address').value = address;
                    document.getElementById('status_modal_mobile1').value = mobile1;
                    document.getElementById('status_modal_mobile2').value = mobile2;
                    document.getElementById('new_status').value = currentStatus;
                    openModal('updateStatusModal');
                }
            });

            document.getElementById('confirmApprove').addEventListener('click', function() {
                const formData = new FormData(document.getElementById('approveForm'));
                fetch("{{ url_for('geasy_bp.approve_pending_user') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        closeModal('approveModal');
                        document.getElementById('successMessage').textContent = 'User Approved Successfully!';
                        document.getElementById('successDetails').innerHTML = `Login ID: <strong>${data.login_id}</strong>`;
                        openModal('successModal');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('An error occurred: ' + error);
                });
            });

            document.getElementById('confirmStatusUpdate').addEventListener('click', function() {
                const formData = new FormData(document.getElementById('updateStatusForm'));
                const userId = formData.get('user_id');
                const newStatus = formData.get('new_status');

                fetch("{{ url_for('geasy_bp.update_user_status') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        closeModal('updateStatusModal');
                        const rows = document.querySelectorAll('tr[data-name]');
                        rows.forEach(row => {
                            const btn = row.querySelector('.update-status-btn');
                            if (btn && btn.getAttribute('data-user-id') === userId) {
                                const statusCell = row.cells[9];
                                if (statusCell) {
                                    statusCell.innerHTML = `<span class="status-badge status-${newStatus.replace(' ', '-')}">${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}</span>`;
                                }
                                row.setAttribute('data-status', newStatus.toLowerCase());
                                btn.setAttribute('data-current-status', newStatus);
                            }
                        });
                        document.getElementById('successMessage').textContent = 'Status Updated Successfully!';
                        document.getElementById('successDetails').innerHTML = `New Status: <strong>${data.new_status}</strong>`;
                        openModal('successModal');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('An error occurred: ' + error);
                });
            });

            document.addEventListener('click', function(e) {
                if (e.target.closest('.view-location-btn')) {
                    const btn = e.target.closest('.view-location-btn');
                    const userId = btn.getAttribute('data-user-id');

                    document.getElementById('mapContainer').innerHTML = '<p>Loading location...</p>';
                    fetch("{{ url_for('geasy_bp.view_location', user_id=0) }}".replace('0', userId))
                        .then(response => response.json())
                        .then(data => {
                            if(data.success) {
                                const location = data.location;
                                if(location) {
                                    const [lat, lng] = location.split(',');
                                    document.getElementById('mapContainer').innerHTML = `
                                        <iframe
                                            width="100%"
                                            height="300"
                                            frameborder="0"
                                            scrolling="no"
                                            marginheight="0"
                                            marginwidth="0"
                                            src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed">
                                        </iframe>
                                    `;
                                } else {
                                    document.getElementById('mapContainer').innerHTML = '<p>Location coordinates not available</p>';
                                }
                            } else {
                                document.getElementById('mapContainer').innerHTML = `<p>${data.message}</p>`;
                            }
                        });
                    openModal('locationModal');
                }
            });

            document.getElementById('successModal').addEventListener('click', function(e) {
                if (e.target.textContent === 'Continue') {
                    const message = document.getElementById('successMessage').textContent;
                    if (message.includes('Approved')) {
                        window.location.reload();
                    } else {
                        closeModal('successModal');
                    }
                }
            });
        });
    </script>
</body>
</html>
{% endblock %}
