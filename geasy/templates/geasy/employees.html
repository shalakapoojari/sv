{% extends 'geasy/navbar.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='geasy/css/styles.css') }}">
<title>Employee Management</title>

<div class="page-container">


    <div class="search-bar">
        <div class="filters-row">
            <p> Enter Employee Login ID or Name to Search:</p>
            <input type="text" id="employee-search" class="form-control" placeholder="Search employees...">
            <button class="btn btn-primary">Search</button>
        </div>
    </div>

    <div class="section-title">
        All Employees
        <span class="record-count">{{ employees|length }} employees</span>
    </div>

    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Login ID</th>
                    <th>Password</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Mobile</th>
                    <th>Status</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="employee-table-body">
                {% for emp in employees %}
                    <tr>
                        <td>{{ emp.login_id }}</td>
                        <td class="password-cell">{{ emp.password }}</td>
                        <td>{{ emp.name }}</td>
                        <td>{{ emp.address }}</td>
                        <td>
                            {{ emp.mobile }}
                            {% if emp.mobile2 %}<br><small>{{ emp.mobile2 }}</small>{% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ emp.status }}">{{ emp.status.title() }}</span>
                        </td>
                        <td>
                            <span class="role-badge role-{{ emp.role.lower() }}">{{ emp.role }}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('geasy_bp.edit_employee', login_id=emp.login_id) }}" 
                                   class="btn-sm btn-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form action="{{ url_for('geasy_bp.delete_employee', user_id=emp.login_id) }}" 
                                      method="POST" style="display:inline;">
                                    <button type="submit" class="btn-sm btn-danger" title="Delete" 
                                            onclick="return confirm('Are you sure?')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="11" class="no-results">No employees found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#employee-search').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        
        if(searchTerm.length >= 2) {
            $.ajax({
                url: "{{ url_for('geasy_bp.manage_employees_data') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ search: searchTerm }),
                success: function(response) {
                    const tableBody = $('#employee-table-body');
                    tableBody.empty();
                    
                    if(response.length === 0) {
                        tableBody.append('<tr><td colspan="11" class="no-results">No matching employees found</td></tr>');
                        return;
                    }
                    
                    response.forEach(function(emp) {
                        const statusClass = `status-${emp.status}`;
                        const roleClass = `role-${emp.role.toLowerCase()}`;
                        const mobile2 = emp.mobile2 ? `<br><small>${emp.mobile2}</small>` : '';
                        
                        const row = `
                            <tr>
                                <td>${emp.login_id}</td>
                                <td class="password-cell">${emp.password}</td>
                                <td>${emp.name}</td>
                                <td>${emp.address || '—'}</td>
                                <td>${emp.mobile}${mobile2}</td>
                                <td>${emp.recharge_date || '—'}</td>
                                <td>${emp.recharge_expiry || '—'}</td>
                                <td><span class="status-badge ${statusClass}">${emp.status.charAt(0).toUpperCase() + emp.status.slice(1)}</span></td>
                                <td><span class="role-badge ${roleClass}">${emp.role}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/geasy/manage/employees/edit/${emp.login_id}" class="btn-sm btn-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form action="/manage/employee/delete/${emp.login_id}" method="POST" style="display:inline;">
                                            <button type="submit" class="btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn-sm btn-primary recharge-btn" data-employee-id="${emp.login_id}" data-employee-name="${emp.name}">
                                        Recharge
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(row);
                    });
                }
            });
        } else if(searchTerm.length === 0) {
            location.reload();
        }
    });

    $(document).on('click', '.recharge-btn', function() {
        const employeeId = $(this).data('employee-id');
        const employeeName = $(this).data('employee-name');
        
        if(confirm(`Initiate recharge for ${employeeName} (${employeeId})?`)) {
            alert('Recharge functionality to be implemented');
        }
    });
});
</script>
{% endblock %}
